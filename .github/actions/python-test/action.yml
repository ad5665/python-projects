name: 'Python Test Action'
description: 'A custom action to run tests, lint, format, and typecheck a Python project.'
inputs:
  project-path:
    description: 'The path to the Python project.'
    required: true
runs:
  using: "composite"
  steps:
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.13'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r ${{ inputs.project-path }}/requirements.txt
        pip install ruff black mypy pytest pytest-cov coverage
      shell: bash

    - name: Lint with ruff
      continue-on-error: true
      run: ruff check ${{ inputs.project-path }}/src ${{ inputs.project-path }}/tests
      shell: bash

    - name: Format with black
      run: black --check ${{ inputs.project-path }}/src ${{ inputs.project-path }}/tests
      shell: bash

    - name: Typecheck with mypy
      run: mypy ${{ inputs.project-path }}/src
      shell: bash

    - name: Test with pytest
      run: pytest --cov=${{ inputs.project-path }}/src ${{ inputs.project-path }}/tests
      shell: bash

    - name: Combine coverage reports
      run: coverage combine
      shell: bash
      working-directory: ${{ inputs.project-path }}

    - name: Generate coverage summary
      run: coverage report --show-missing > coverage_summary.md
      shell: bash
      working-directory: ${{ inputs.project-path }}

    - name: Display coverage summary in job summary
      run: |
        echo "## Code Coverage Summary for $(echo ${{ inputs.project-path }} | cut -d '/' -f 2)" >> $GITHUB_STEP_SUMMARY
        echo '```' >> $GITHUB_STEP_SUMMARY
        cat ${{ inputs.project-path }}/coverage_summary.md >> $GITHUB_STEP_SUMMARY
        echo '```' >> $GITHUB_STEP_SUMMARY
      shell: bash
